function loadGoogleMapsAPI() {
    if (typeof google !== "undefined" && google.maps) {
        console.log("‚úÖ Google Maps API ju≈º za≈Çadowane.");
        initMap();
        return;
    }

    console.log("‚è≥ ≈Åadowanie Google Maps API...");
    
    let script = document.createElement("script");
    script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBQfbB1-KewAmrPcoPXq4aYNsQggT1iPHY&libraries=places&callback=initMap";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// üîπ 1. GLOBALNE ZMIENNE
let map;
let directionsService;
let directionsRenderer;
let previousToPickupLine = null; // üî• Dodaj tƒô liniƒô

// üîπ 2. FUNKCJA `initMap()` ‚Äì Tworzenie mapy
function initMap() {
    let mapDiv = document.getElementById("map");

    if (!mapDiv) {
        console.error("‚ùå B≈ÇƒÖd: Brak elementu `#map` w HTML!");
        return;
    }

    if (typeof google === "undefined" || !google.maps) {
        console.error("‚ùå Google Maps API nie jest jeszcze gotowe.");
        return;
    }

    map = new google.maps.Map(mapDiv, {
        zoom: 6,
        center: { lat: 52.2297, lng: 21.0122 },
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        draggable: true // üîπ Teraz linia trasy jest edytowalna!
    });

    // üîπ Nas≈Çuchiwanie na zmiany w trasie
    google.maps.event.addListener(directionsRenderer, "directions_changed", function () {
        recalculateDistance();
    });

    console.log("‚úÖ Mapa za≈Çadowana poprawnie.");
}
window.initMap = initMap; // SPRAWDZAMY, CZY FUNKCJA `initMap()` JEST DOSTƒòPNA GLOBALNIE

// üîπ 2.1. AUTOUZUPE≈ÅNIANIE DLA URZƒÑDZE≈É MOBILNYCH
function fixAutocompleteOnTouch(input) {
    input.addEventListener("focus", function () {
        let event = new Event("keydown", { bubbles: true, cancelable: true });
        event.keyCode = 40; // Symulujemy strza≈Çkƒô w d√≥≈Ç, aby otworzyƒá listƒô
        input.dispatchEvent(event);
    });
}

// üîπ 3. INICJALIZACJA SKRYPTU PO ZA≈ÅADOWANIU STRONY
document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Dokument za≈Çadowany!");

    loadGoogleMapsAPI(); // üî• Teraz API ≈Çaduje siƒô asynchronicznie

    waitForGoogleMaps(() => {
        initMap();
        
        let pickupInput = document.getElementById("pickup");
        let deliveryInput = document.getElementById("delivery");
        let previousDeliveryInput = document.getElementById("previous-delivery");
        let stopsContainer = document.getElementById("stops-container");

        if (pickupInput) initAutocomplete(pickupInput);
        if (deliveryInput) initAutocomplete(deliveryInput);
        if (previousDeliveryInput) initAutocomplete(previousDeliveryInput);

        if (deliveryInput) {
            deliveryInput.addEventListener("blur", function () {
                setCountryFromAddress();
                updateRoute();
            });
        }

        if (pickupInput) {
            pickupInput.addEventListener("blur", function () {
                updateRoute();
                drawPreviousToPickupLine();
            });
        }

        if (stopsContainer) {
            stopsContainer.addEventListener("input", updateRoute);
        }

        if (previousDeliveryInput) {
            previousDeliveryInput.addEventListener("blur", function () {
                drawPreviousToPickupLine();
                calculateRoute();
            });
        }

        document.getElementById("calculate-distance").addEventListener("click", calculateRoute);
        document.getElementById("add-stop").addEventListener("click", addStop);
        document.getElementById("transport-form").addEventListener("submit", function (event) {
            event.preventDefault();
            console.log("üì© Formularz wys≈Çany!");
        });

        document.getElementById("add-route-button").addEventListener("click", function () {
            updateTable();
            document.getElementById("transport-form").reset();
        });

        // üî• Ustawienie autouzupe≈Çniania dla dynamicznie dodawanych przystank√≥w
        stopsContainer.addEventListener("DOMNodeInserted", function (event) {
            if (event.target && event.target.querySelector(".stop-input")) {
                initAutocomplete(event.target.querySelector(".stop-input"));
            }
        });
        
    });
});

// üîπ 4. AUTOUZUPE≈ÅNIANIE ADRES√ìW Z GOOGLE PLACES API (OGRANICZONE DO EUROPY)
function initAutocomplete(input) {
    if (!checkGoogleMapsLoaded()) {
        console.warn(`‚è≥ Czekam na Google Maps API dla: ${input.id}`);
        setTimeout(() => initAutocomplete(input), 1000); // Powtarzamy co 1 sek.
        return;
    }

    let autocomplete = new google.maps.places.Autocomplete(input, {
        types: ["geocode"], // Pomaga filtrowaƒá wyniki do adres√≥w
    });

    autocomplete.addListener("place_changed", function () {
        let place = autocomplete.getPlace();
        if (!place || !place.address_components) {
            console.warn(`‚ö†Ô∏è Nie uda≈Ço siƒô pobraƒá szczeg√≥≈Ç√≥w miejsca dla: ${input.id}`);
            return;
        }

        let country = getCountryFromPlace(place);
        
        // üî• Ograniczamy tylko do kraj√≥w europejskich
        if (!isEuropeanCountry(country)) {
            console.warn(`üö´ Wybrany kraj (${country}) nie znajduje siƒô w Europie.`);
            alert("üåç Wybierz adres w Europie!");
            input.value = ""; // Czy≈õcimy pole
            return;
        }

        input.setAttribute("data-place", JSON.stringify(place));
        console.log(`‚úÖ Dane miejsca zapisane dla: ${input.id}, Kraj: ${country}`);

        // üî• Je≈õli u≈ºytkownik wybierze miejsce w `delivery`, aktualizujemy trasƒô!
        if (input.id === "delivery") {
            setCountryFromAddress();
            updateRoute();
        }
    });

    console.log(`üîπ Autouzupe≈Çnianie aktywowane dla: ${input.id}`);

    // üî• Naprawa problemu z autouzupe≈Çnianiem na ekranach dotykowych
    fixAutocompleteOnTouch(input);
}

// üîπ Pobiera kraj z obiektu `place`
function getCountryFromPlace(place) {
    for (let component of place.address_components) {
        if (component.types.includes("country")) {
            return component.short_name; // Zwraca kod kraju (np. "PL" dla Polski)
        }
    }
    return null;
}

// üîπ Sprawdza, czy kraj nale≈ºy do Europy
function isEuropeanCountry(countryCode) {
    const europeanCountries = [
        "AT", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", 
        "GB", "GR", "HR", "HU", "IE", "IS", "IT", "LI", "LT", "LU", "LV", "MC", 
        "MT", "NL", "NO", "PL", "PT", "RO", "SE", "SI", "SK", "SM", "VA"
    ];
    return europeanCountries.includes(countryCode);
}


// üîπ 5. SPRAWDZANIE, CZY GOOGLE MAPS API JEST ZA≈ÅADOWANE
function checkGoogleMapsLoaded() {
    if (typeof google === "undefined" || !google.maps) {
        console.error("‚ùå Google Maps API nie zosta≈Ço za≈Çadowane!");
        return false;
    }
    return true;
}

// üîπ 6. AUTOMATYCZNE UZUPE≈ÅNIANIE KRAJU ROZ≈ÅADUNKU I VAT
const vatRates = {
    "Austria": "23%", "Belgia": "23%", "Bu≈Çgaria": "23%", "Francja": "23%",
    "Niemcy": "23%", "Polska": "23%", "W≈Çochy": "23%", "Norwegia": "0%",
    "Szwajcaria": "0%", "Wielka Brytania": "0%", "Turcja": "0%"
};

function setCountryFromAddress() {
    let deliveryInput = document.getElementById("delivery");
    let countryInput = document.getElementById("country");

    if (!deliveryInput || !countryInput) return;

    let placeData = deliveryInput.getAttribute("data-place");
    if (!placeData) return;

    let place = JSON.parse(placeData);
    let country = "Nieznany";

    if (place && place.address_components) {
        place.address_components.forEach(component => {
            if (component.types.includes("country")) {
                country = component.long_name;
            }
        });
    }

    countryInput.value = country;
    console.log(`üåç Kraj roz≈Çadunku: ${country}`);

    setVatRate();
}
// üîπ 9. DODAWANIE PRZYSTANK√ìW
function addStop() {
    let stopsContainer = document.getElementById("stops-container");

    let stopDiv = document.createElement("div");
    stopDiv.classList.add("stop-container");

    let stopInput = document.createElement("input");
    stopInput.type = "text";
    stopInput.name = "stop";
    stopInput.classList.add("stop-input");
    stopInput.placeholder = "Wpisz przystanek";

    let removeButton = document.createElement("button");
    removeButton.type = "button";
    removeButton.classList.add("delete-stop");
    removeButton.innerHTML = "üóë";
    removeButton.addEventListener("click", function () {
        stopDiv.remove();
        updateRoute(); // Aktualizacja trasy po usuniƒôciu przystanku
    });

    stopDiv.appendChild(stopInput);
    stopDiv.appendChild(removeButton);
    stopsContainer.appendChild(stopDiv);

    initAutocomplete(stopInput); // Autouzupe≈Çnianie dla nowo dodanego przystanku
}

function setVatRate() {
    let countryInput = document.getElementById("country");
    let vatRateInput = document.getElementById("vat-rate");

    if (!countryInput || !vatRateInput) return;

    let country = countryInput.value;
    vatRateInput.value = vatRates[country] || "Nieznana";
}

// üîπ 7. WYB√ìR FIRMY I NUMERY AUT
const vehicles = {
    grand: [
        "FZ5217S", "FZ0291S", "FZ0292S", "FZ0293S", "FZ0294S", "FZ0523S", 
        "FZ0613S", "FZ3609S", "FZ4346S", "FZ4308S", "FZ4317S", "FZ4405S", 
        "FZ9892S", "FZ0413T", "FZ0569T", "FZ0570T", "FZ0739T", "FZ0740U", 
        "FZ5474U", "SR3687T", "FZ8190U"
    ],
    graal_wit: [
        "FZ3909R", "WGM2833F", "FZ8606R", "TK326AV", "TKI4674K", "FZ1936S", 
        "FZ2014S", "WPR8501P", "WPR8502P", "WPR8503P", "WPR8504P", "FZ0295S", 
        "FZ0296S", "FZ3611S", "FZ3648S", "FZ3631S", "FZ4404S", "FZ9893S", 
        "FZ0414T", "FZ0691T", "FZ0692T", "FZ0693T", "FZ0464U", "FZ0035R", 
        "FZ3621V", "SR8402T"
    ]
};

document.addEventListener("DOMContentLoaded", function () {
    let companySelect = document.getElementById("company");
    let vehicleSelect = document.getElementById("vehicle");

    if (companySelect && vehicleSelect) {
        companySelect.addEventListener("change", function () {
            vehicleSelect.innerHTML = "<option value=''>-- Wybierz samoch√≥d --</option>";

            if (this.value && vehicles[this.value]) {
                vehicles[this.value].forEach(vehicle => {
                    let option = document.createElement("option");
                    option.value = vehicle;
                    option.textContent = vehicle;
                    vehicleSelect.appendChild(option);
                });
            }

            vehicleSelect.disabled = false;
        });
    }
});

// üîπ 8. LICZENIE TRASY Z PRZYSTANKAMI (Z UWZGLƒòDNIENIEM POPRZEDNIEGO ROZ≈ÅADUNKU)
function calculateRoute() {
    if (!map || !directionsService || !directionsRenderer) {
        console.error("‚ùå B≈ÇƒÖd: Mapa nie zosta≈Ça jeszcze zainicjalizowana!");
        return;
    }

    let previousDeliveryInput = document.getElementById("previous-delivery");
    let pickupInput = document.getElementById("pickup");
    let deliveryInput = document.getElementById("delivery");
    let distanceResult = document.getElementById("distance-result");
    let mapLinkInput = document.getElementById("map-link"); // üîπ Pobieramy pole do wy≈õwietlania linku

    let previousDeliveryAddress = previousDeliveryInput ? previousDeliveryInput.value.trim() : "";
    let pickupAddress = pickupInput.value.trim();
    let deliveryAddress = deliveryInput.value.trim();

    if (!pickupAddress || !deliveryAddress) {
        alert("‚ùó Podaj adres za≈Çadunku i roz≈Çadunku.");
        return;
    }

    let waypoints = [];
    document.querySelectorAll(".stop-input").forEach(input => {
        if (input.value.trim() !== "") {
            waypoints.push({
                location: input.value.trim(),
                stopover: true
            });
        }
    });

    let tollRoadsElement = document.getElementById("toll-roads");
    let avoidTolls = tollRoadsElement ? !tollRoadsElement.checked : true;
    let avoidFerries = true;

    // üî• Je≈õli u≈ºytkownik poda≈Ç poprzedni roz≈Çadunek, ustawiamy go jako punkt startowy
    let startAddress = previousDeliveryAddress ? previousDeliveryAddress : pickupAddress;

    let request = {
        origin: startAddress, // Uwzglƒôdnia poprzedni roz≈Çadunek, je≈õli podany
        destination: deliveryAddress,
        waypoints: waypoints,
        travelMode: "DRIVING",
        avoidTolls: avoidTolls,
        avoidFerries: avoidFerries
    };

    directionsService.route(request, function (result, status) {
        if (status === "OK") {
            directionsRenderer.setDirections(result);

            let totalDistance = result.routes[0].legs.reduce((acc, leg) => acc + leg.distance.value, 0);
            distanceResult.innerText = `≈ÅƒÖczny dystans: ${(totalDistance /
                1000).toFixed(1)} km`;
                // üîπ GENEROWANIE LINKU DO TRASY W GOOGLE MAPS
            let mapsURL = `https://www.google.com/maps/dir/${encodeURIComponent(startAddress)}`;
            waypoints.forEach(wp => {
                mapsURL += `/${encodeURIComponent(wp.location)}`;
            });
            mapsURL += `/${encodeURIComponent(deliveryAddress)}`;

            mapLinkInput.value = mapsURL; // üî• Wy≈õwietlenie linku w polu
        } else {
            distanceResult.innerText = `B≈ÇƒÖd: ${status}`;
            console.error(`‚ùå B≈ÇƒÖd Google Maps: ${status}`);
        }
    });
}
// POD≈öWIETLANIE POPRZEDNIEGO ODCINKA TRASY
function drawPreviousToPickupLine() {
    let previousDeliveryInput = document.getElementById("previous-delivery");
    let pickupInput = document.getElementById("pickup");

    let previousAddress = previousDeliveryInput ? previousDeliveryInput.value.trim() : "";
    let pickupAddress = pickupInput.value.trim();

    if (!previousAddress || !pickupAddress) {
        if (previousToPickupLine) {
            previousToPickupLine.setMap(null); // Usuwamy starƒÖ liniƒô, je≈õli nie ma adresu
            previousToPickupLine = null;
        }
        return;
    }

    let geocoder = new google.maps.Geocoder();
    
    geocoder.geocode({ address: previousAddress }, function (prevResults, prevStatus) {
        if (prevStatus !== "OK") {
            console.error("‚ùå Nie mo≈ºna znale≈∫ƒá lokalizacji poprzedniego roz≈Çadunku:", prevStatus);
            return;
        }
        
        geocoder.geocode({ address: pickupAddress }, function (pickupResults, pickupStatus) {
            if (pickupStatus !== "OK") {
                console.error("‚ùå Nie mo≈ºna znale≈∫ƒá lokalizacji za≈Çadunku:", pickupStatus);
                return;
            }
            
            let previousLocation = prevResults[0].geometry.location;
            let pickupLocation = pickupResults[0].geometry.location;

            if (previousToPickupLine) {
                previousToPickupLine.setMap(null); // Usuniƒôcie starej linii
            }

            previousToPickupLine = new google.maps.Polyline({
                path: [previousLocation, pickupLocation],
                geodesic: true,
                strokeColor: "#FF69B4", // R√≥≈ºowy kolor
                strokeOpacity: 1.0,
                strokeWeight: 4
            });

            previousToPickupLine.setMap(map);
        });
    });
}

// üîπ 9. PRZELICZANIE DYSTANSU PO ZMIANIE TRASY
function recalculateDistance() {
    let distanceResult = document.getElementById("distance-result");
    let directions = directionsRenderer.getDirections();

    if (!directions || !directions.routes || directions.routes.length === 0) {
        distanceResult.innerText = "B≈ÇƒÖd: Nie mo≈ºna przeliczyƒá dystansu.";
        return;
    }

    let totalDistance = directions.routes[0].legs.reduce((acc, leg) => acc + leg.distance.value, 0);
    distanceResult.innerText = `≈ÅƒÖczny dystans: ${(totalDistance / 1000).toFixed(1)} km`;

    console.log(`üîÑ Trasa zmodyfikowana. Nowy dystans: ${(totalDistance / 1000).toFixed(1)} km`);
}
// üîπ 10. AKTUALIZACJA POLA "TRASA" Z KODAMI POCZTOWYMI I KRAJAMI
function updateRoute() {
    let pickupInput = document.getElementById("pickup");
    let deliveryInput = document.getElementById("delivery");
    let routeInput = document.getElementById("route");
    let truckTypeSwitch = document.getElementById("truck-type"); // üî• Pobieramy stan prze≈ÇƒÖcznika

    if (!pickupInput || !deliveryInput || !routeInput) return;
    if (!pickupInput.value.trim() || !deliveryInput.value.trim()) {
        console.warn("‚ö†Ô∏è Nie mo≈ºna zaktualizowaƒá trasy - brak danych.");
        return;
    }

    let pickupCode = getPostalCode(pickupInput);
    let deliveryCode = getPostalCode(deliveryInput);

    let stopsCodes = Array.from(document.querySelectorAll(".stop-input"))
        .map(stop => getPostalCode(stop))
        .filter(code => code !== "");

        if (truckTypeSwitch.checked) {
            // üîπ TRYB EUROPEJEC (DOMY≈öLNY)

    let fullRoute = [pickupCode, ...stopsCodes, deliveryCode].join("-");
    routeInput.value = fullRoute;

} else {
    // üîπ TRYB MEBLOWY (SPECJALNE FORMATOWANIE)
if (stopsCodes.length > 0) {
    let firstStop = stopsCodes[0]; // üî• Pierwszy przystanek
    let firstStopPrefix = firstStop.substring(0, 2); // Prefiks kraju
    let firstStopPostal = firstStop.match(/\d{2}/); // Pierwsze dwie cyfry kodu pocztowego

    let formattedStops = `${firstStopPrefix}${firstStopPostal ? firstStopPostal[0] : "00"}*${stopsCodes.length}`;
    let fullRoute = `${pickupCode}-${formattedStops}-${deliveryCode}`;

    routeInput.value = fullRoute;
} else {
    // üîπ Je≈õli brak przystank√≥w ‚Üí standardowy format
    routeInput.value = `${pickupCode}-${deliveryCode}`;
}

}

console.log("üöõ Trasa wygenerowana:", routeInput.value);
}
// üîπ 11. POBIERANIE KODU POCZTOWEGO I KRAJU
function getPostalCode(input) {
    if (!input) return "";
    
    let placeData = input.getAttribute("data-place");
    if (!placeData) {
        console.warn(`‚ö†Ô∏è Brak danych miejsca dla: ${input.id}`);
        return "";
    }

    let place = JSON.parse(placeData);
    if (!place || !place.address_components) {
        console.warn(`‚ö†Ô∏è Brak komponent√≥w adresu dla: ${input.id}`);
        return "";
    }

    let postalCode = "";
    let countryPrefix = "";

    place.address_components.forEach(component => {
        if (component.types.includes("postal_code")) {
            postalCode = component.long_name;
        }
        if (component.types.includes("country")) {
            countryPrefix = countrySymbols[component.short_name] || component.short_name;
        }
    });

    if (!postalCode || !countryPrefix) {
        console.warn(`‚ö†Ô∏è Nie uda≈Ço siƒô pobraƒá kodu pocztowego lub kraju dla: ${input.id}`);
        return "";
    }

    console.log(`üìå Pobrano dla ${input.id}: ${countryPrefix}${postalCode}`);
    return countryPrefix + postalCode;
}

const countrySymbols = {
    "PL": "PL", "DE": "DE", "FR": "FR", "ES": "ES", "IT": "IT",
    "GB": "UK", "NL": "NL", "BE": "BE", "AT": "AT", "CH": "CH",
    "DK": "DK", "SE": "SE", "NO": "NO", "FI": "FI", "CZ": "CZ",
    "SK": "SK", "HU": "HU", "LT": "LT", "LV": "LV", "EE": "EE",
    "PT": "PT", "GR": "GR", "RO": "RO", "BG": "BG", "IE": "IE"
};
// üîπ 12. AKTUALIZACJA TABELI PO KLIKNIƒòCIU PRZYCISKU
function updateTable() {
    let vehicle = document.getElementById("vehicle").value || "";
    let pickupDate = document.getElementById("pickup-date").value || "";
    let deliveryDate = document.getElementById("delivery-date").value || "";
    let pickupAddress = document.getElementById("pickup").value || "";
    let deliveryAddress = document.getElementById("delivery").value || "";
    let route = document.getElementById("route").value || "";
    let plannedKm = document.getElementById("distance-result").innerText.replace("≈ÅƒÖczny dystans: ", "").replace(" km", "") || "";
    let country = document.getElementById("country").value || "";
    let pickupTime = document.getElementById("pickup-time").value || ""; // NOWE POLE
    let deliveryTime = document.getElementById("delivery-time").value || ""; // NOWE POLE
    let mapLink = document.getElementById("map-link").value || "Brak linku"; // NOWE POLE

    // üîπ Pobranie trybu meblowego
    let truckTypeSwitch = document.getElementById("truck-type");

    // üîπ Pobranie nazwy plik√≥w za≈ÇƒÖcznik√≥w (tylko dla trybu europejskiego)
    let cmrPhoto = document.getElementById("cmr-photo").files.length > 0 ? document.getElementById("cmr-photo").files[0].name : "";
    let hotelInvoice = document.getElementById("hotel-invoice").files.length > 0 ? document.getElementById("hotel-invoice").files[0].name : "";

    // üîπ Pobranie linku do trasy, je≈õli jest tryb meblowy
    let routeLink = "Brak linku";
    if (!truckTypeSwitch.checked) { // Tryb meblowy
        let pickup = encodeURIComponent(pickupAddress);
        let delivery = encodeURIComponent(deliveryAddress);
        let stops = Array.from(document.querySelectorAll(".stop-input"))
            .map(input => encodeURIComponent(input.value.trim()))
            .filter(stop => stop !== "");

        let mapsURL = `https://www.google.com/maps/dir/${pickup}`;
        stops.forEach(stop => {
            mapsURL += `/${stop}`;
        });
        mapsURL += `/${delivery}`;

        routeLink = mapsURL;
    }

    console.log("üîó Link do trasy:", routeLink); // Sprawdzenie w konsoli


     // üîπ Formatowanie daty do "DD-MM / DD-MM"
let formattedDate = "";
if (pickupDate && deliveryDate) {
    let pickupFormatted = pickupDate.split("-").reverse().slice(0, 2).join("-"); // YYYY-MM-DD ‚Üí DD-MM
    let deliveryFormatted = deliveryDate.split("-").reverse().slice(0, 2).join("-");
    formattedDate = `${pickupFormatted} / ${deliveryFormatted}`;
}

let tbody = document.querySelector("#data-table tbody");

// üîπ Sprawdzenie, czy istnieje ostatni wiersz i pobranie danych
let lastRow = tbody.lastElementChild;
let lastDeliveryAddress = "";

if (lastRow && lastRow.cells.length > 1) { 
    lastDeliveryAddress = lastRow.cells[7].textContent.trim(); // Pobiera adres roz≈Çadunku z ostatniego wiersza
}

// üî• Ustawienie poprzedniego roz≈Çadunku ZAWSZE na ostatni wpis z tabeli
document.getElementById("previous-delivery").value = lastDeliveryAddress;

// üîπ Tworzymy nowy wiersz
let row = document.createElement("tr");

// üîπ Tworzymy przycisk "Usu≈Ñ trasƒô"
let deleteButton = document.createElement("button");
deleteButton.textContent = "üóë Usu≈Ñ";
deleteButton.classList.add("delete-button");
deleteButton.addEventListener("click", function () {
    row.remove(); // üî• Usuwa tylko ten jeden wiersz
});

row.innerHTML = `
    <td>${vehicle}</td>
    <td>${formattedDate}</td>
    <td>${route}</td>
    <td>${pickupDate}</td>
    <td>${pickupAddress}</td>
    <td>${pickupTime}</td> <!-- NOWA KOLUMNA -->
    <td>${deliveryDate}</td>
    <td>${deliveryAddress}</td>
    <td>${deliveryTime}</td> <!-- NOWA KOLUMNA -->
    <td><a href="${mapLink}" target="_blank">üîó Trasa</a></td> <!-- NOWA KOLUMNA -->
    <td></td> <!-- Nr zlecenia (puste) -->
    <td></td> <!-- ZLECENIE PDF (puste) -->
    <td>${plannedKm}</td>
    <td></td> <!-- KWOTA ZLECENIA (puste) -->
    <td></td> <!-- Stawka (puste) -->
    <td></td> <!-- Hotele (puste) -->
    <td>${hotelInvoice}</td> <!-- FAKTURA ZA HOTEL -->
    <td></td> <!-- R√≥≈ºnica (puste) -->
    <td></td> <!-- Op≈Çaty za drogi (puste) -->
    <td></td> <!-- Paliwo (puste) -->
    <td></td> <!-- Faktura (puste) -->
    <td></td> <!-- DATA WYSTAWIENIA (puste) -->
    <td></td> <!-- FAKTURA PDF (puste) -->
    <td>${cmrPhoto}</td> <!-- DOKUMENTY CMR -->
    <td>${country}</td>
`;

// üî• RESETUJEMY WSZYSTKIE INNE POLA PO DODANIU WIERSZA
document.getElementById("vehicle").value = "";
document.getElementById("pickup-date").value = "";
document.getElementById("delivery-date").value = "";
document.getElementById("pickup").value = "";
document.getElementById("delivery").value = "";
document.getElementById("route").value = "";
document.getElementById("pickup-time").value = "";
document.getElementById("delivery-time").value = "";
document.getElementById("map-link").value = "";
document.getElementById("country").value = "";

// ‚ùå USUWAMY RESETOWANIE "Poprzedniego Roz≈Çadunku" po zmianie pojazdu!

    // üîπ Dodajemy przycisk "Usu≈Ñ" do wiersza
    let deleteCell = document.createElement("td");
    deleteCell.appendChild(deleteButton);
    row.prepend(deleteCell);

// üî• Dodajemy nowy wiersz do tabeli (bez usuwania poprzednich)
tbody.appendChild(row);
}

document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Dokument w pe≈Çni za≈Çadowany!");

    let addRouteButton = document.getElementById("add-route-button"); // ZAMIANA
    let copyButton = document.getElementById("copy-button");
    let removeDuplicatesButton = document.getElementById("usun-duplikaty-button"); // Nowy przycisk


    if (addRouteButton) { // ZAMIANA
        addRouteButton.addEventListener("click", function () { // ZAMIANA
            updateRoute(); // Najpierw aktualizuje trasƒô
            updateTable(); // Potem dodaje nowy wiersz do tabeli
        });
    } else {
        console.error("‚ùå B≈ÇƒÖd: Nie znaleziono przycisku `add-route-button`!"); // ZAMIANA
    }

    if (copyButton) {
        copyButton.addEventListener("click", function () {
            let rows = document.querySelectorAll("#data-table tbody tr"); // Pobiera wszystkie wiersze w tabeli
            let copiedText = "";

            if (rows.length === 0) {
                alert("‚ö†Ô∏è Brak danych do skopiowania!");
                return;
            }

            rows.forEach(row => {
                let rowText = Array.from(row.children)
    .slice(1) // Pomija pierwszƒÖ kolumnƒô ("Usu≈Ñ")
    .map(cell => cell.textContent.trim()) // Pobiera tylko tekst
    .join("\t"); // Format TSV (Tab-separated values)
                copiedText += rowText + "\n";
            });

            navigator.clipboard.writeText(copiedText).then(() => {
                alert("üìã Wszystkie trasy skopiowane do schowka!");
            });
        });
    } else {
        console.error("‚ùå B≈ÇƒÖd: Nie znaleziono przycisku `copy-button`!");
    }

    // üî• NOWY OBS≈ÅUGIWANY PRZYCISK "USU≈É DUPLIKATY"
    if (removeDuplicatesButton) {
        removeDuplicatesButton.addEventListener("click", function () {
            removeDuplicates();
        });
    } else {
        console.error("‚ùå B≈ÇƒÖd: Nie znaleziono przycisku `usun-duplikaty-button`!");
    }
});

window.initMap = initMap;

// üîπ Ostrze≈ºenie przed od≈õwie≈ºeniem strony lub zamkniƒôciem karty
window.addEventListener("beforeunload", function (event) {
    event.preventDefault(); // Standardowe zachowanie przeglƒÖdarki
    event.returnValue = "Czy na pewno chcesz od≈õwie≈ºyƒá stronƒô? Wszystkie utworzone trasy zostanƒÖ usuniƒôte.";
});
// üîπ Ukrywanie ekranu ≈Çadowania
function hideLoadingScreen() {
    let loadingScreen = document.getElementById("loading-screen");
    if (loadingScreen) {
        loadingScreen.style.display = "none";
    }
}
// 14 üîπ OBS≈ÅUGA PRZE≈ÅƒÑCZNIKA TRYBU (Europejec / Meblowy)
document.addEventListener("DOMContentLoaded", function () {
    let truckTypeSwitch = document.getElementById("truck-type");
    let truckTypeLabel = document.getElementById("truck-type-label");

    // üî• Sprawdza ostatnie zapisane ustawienie w localStorage
    let savedMode = localStorage.getItem("truckTypeMode");
    if (savedMode === "europejec") {
        truckTypeSwitch.checked = true;
        truckTypeLabel.textContent = "Europejec";
    } else {
        truckTypeSwitch.checked = false;
        truckTypeLabel.textContent = "Meblowy";
    }

    // üî• Zmienia tekst i zapisuje wyb√≥r po klikniƒôciu prze≈ÇƒÖcznika
    truckTypeSwitch.addEventListener("change", function () {
        if (this.checked) {
            truckTypeLabel.textContent = "Europejec";
            localStorage.setItem("truckTypeMode", "europejec");
        } else {
            truckTypeLabel.textContent = "Meblowy";
            localStorage.setItem("truckTypeMode", "meblowy");
        }
    });
});
// 15.üîπ Sprawdza, czy Google Maps API jest za≈Çadowane
function waitForGoogleMaps(callback, retries = 5) {
    let attempts = 0;

    function check() {
        if (typeof google !== "undefined" && google.maps) {
            console.log("‚úÖ Google Maps API gotowe!");
            hideLoadingScreen(); // üî• Ukrywa ekran ≈Çadowania
            callback();
        } else {
            attempts++;
            if (attempts < retries) {
                console.warn(`‚è≥ Google Maps API niegotowe. Pr√≥ba ${attempts}/${retries}...`);
                setTimeout(check, 2000); // Sprawdza co 2 sekundy
            } else {
                console.error("‚ùå Google Maps API NIE za≈Çadowa≈Ço siƒô! Pr√≥bujƒô ponownie...");
                reloadGoogleMaps(); // üîÑ Prze≈Çadowuje API
                setTimeout(() => waitForGoogleMaps(callback, retries), 5000); // üîÅ Kolejna pr√≥ba za 5 sekund
            }
        }
    }
    check();
}
document.addEventListener("DOMContentLoaded", function () {
    let shareButton = document.getElementById("share-route-button");

    if (shareButton) {
        shareButton.addEventListener("click", function () {
            let pickup = document.getElementById("pickup").value.trim();
            let delivery = document.getElementById("delivery").value.trim();
            let stops = Array.from(document.querySelectorAll(".stop-input"))
                .map(input => input.value.trim())
                .filter(stop => stop !== "");

            let distanceText = document.getElementById("distance-result").innerText || "Brak danych";
            let distanceValue = distanceText.replace("≈ÅƒÖczny dystans: ", "").replace(" km", "").trim();

            if (!pickup || !delivery) {
                alert("‚ùó Podaj adres za≈Çadunku i roz≈Çadunku przed udostƒôpnieniem.");
                return;
            }

            // Tworzymy adres URL do Google Maps
            let mapsURL = `https://www.google.com/maps/dir/${encodeURIComponent(pickup)}`;
            stops.forEach(stop => {
                mapsURL += `/${encodeURIComponent(stop)}`;
            });
            mapsURL += `/${encodeURIComponent(delivery)}`;

            // Tworzymy pe≈Çny link do udostƒôpnienia z dystansem
            let shareText = `üìç Trasa: ${pickup} ‚ûù ${stops.join(" ‚ûù ")} ‚ûù ${delivery}\nüöõ Dystans: ${distanceValue} km\nüîó Mapa: ${mapsURL}`;

            // Kopiowanie linku do schowka
            navigator.clipboard.writeText(shareText).then(() => {
                alert("üìç Link do trasy zosta≈Ç skopiowany do schowka:\n" + shareText);
            }).catch(err => {
                console.error("‚ùå B≈ÇƒÖd podczas kopiowania linku:", err);
                alert("‚ùå Nie uda≈Ço siƒô skopiowaƒá linku.");
            });

            // Otw√≥rz mapƒô w nowej karcie
            window.open(mapsURL, "_blank");
        });
    }
});


// 16.üîπ Funkcja ponownego ≈Çadowania Google Maps API
function reloadGoogleMaps() {
    console.warn("üîÑ Ponowne ≈Çadowanie Google Maps API...");
    let oldScript = document.querySelector("script[src*='maps.googleapis']");
    if (oldScript) oldScript.remove();

    let newScript = document.createElement("script");
    newScript.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBQfbB1-KewAmrPcoPXq4aYNsQggT1iPHY&libraries=places&callback=initMap";
    newScript.async = true;
    newScript.defer = true;
    document.head.appendChild(newScript);
}

// 17. üîπ FUNKCJA USUWANIA DUPLIKAT√ìW
function removeDuplicates() {
    let table = document.getElementById("data-table");
    let rows = Array.from(table.querySelectorAll("tbody tr"));

    let uniqueRows = new Set(); // Zestaw do przechowywania unikalnych wpis√≥w

    rows.forEach(row => {
        let rowData = Array.from(row.children)
            .slice(1) // Pomijamy pierwszƒÖ kolumnƒô ("Usu≈Ñ")
            .map(cell => cell.textContent.trim()) // Pobieramy zawarto≈õƒá ka≈ºdej kom√≥rki
            .join("|"); // Tworzymy unikalny identyfikator wiersza

        if (uniqueRows.has(rowData)) {
            row.remove(); // Je≈õli wpis ju≈º istnieje, usuwamy duplikat
        } else {
            uniqueRows.add(rowData); // Je≈õli nowy wpis, dodajemy do zestawu
        }
    });

    alert("‚úÖ Duplikaty zosta≈Çy usuniƒôte!");
}

// üîπ Inicjalizacja mapy z systemem powtarzania
waitForGoogleMaps(initMap);